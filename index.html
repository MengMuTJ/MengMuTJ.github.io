<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <title>World Happiness Chart</title>
</head>

<body onload="init()" id="container">

    <h1>World Happiness Score Ranking (2015 - 2019)</h1>

    <div id="year-container">
        <p>Select a scene:</p>
        <button onclick="loadRanking()">Ranking (Home)</button>
        <button onclick="loadLifeView()">Life Expectancy</button>
        <button onclick="loadGDPView()">GDP Per Capita</button>
    </div>

    <div id="year-container">
        <p>Select a year:</p>
        <button onclick="updateBar(data15)">2015</button>
        <button onclick="updateBar(data16)">2016</button>
        <button onclick="updateBar(data17)">2017</button>
        <button onclick="updateBar(data18)">2018</button>
        <button onclick="updateBar(data19)">2019</button>
    </div>

    <div id="dataviz"><svg id="happiness"></svg></div>

    <script>
        const loadGDPView = () => {
            window.location="gdp-scene.html";
        }
        const loadLifeView = () => {
            window.location="life-scene.html";
        }
        const loadRanking = () => {
            window.location = "index.html";
        }
        let data15, data16, data17, data18, data19
        const margin = { top: 20, right: 30, bottom: 40, left: 150 };
        const width = 1000 - margin.left - margin.right;
        const height = 1600 - margin.top - margin.bottom;

        const svg = d3
            .select("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        const y_scale = d3
            .scaleBand()
            .range([0, height])
            .padding(0.2);
        const yAxis = svg.append("g")

        const x_scale = d3.scaleLinear().domain([0, 9]).range([0, width]);
        const xAxis = svg
            .append("g")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x_scale))
            .selectAll("text")
            .attr("transform", "translate(2,0)")
            .style("text-anchor", "end");

        const updateBar = (data) => {
            const sortedData = data.sort((a, b) =>
                a.score < b.score ? 1 : a.score > b.score ? -1 : 0
            );

            y_scale.domain(sortedData.map((d) => { return d.country }))
            yAxis.transition().duration(1000).call(d3.axisLeft(y_scale));

            const annotations = [
                {
                    note: {
                        label: `${sortedData[0].country} had a score of ${Number(sortedData[0].score).toFixed(2)}. It was ranked as the happiest country in the world in the year of ${sortedData[0].year}.`,
                        title: `${sortedData[0].country}`
                    },
                    connector: {
                        end: "dot",
                        type: "line",
                        lineType: "vertical",
                        endScale: 1
                    },
                    x: 830,
                    y: 25,
                    dy: 20,
                    dx: 100
                }].map(function (d) { d.color = "#E8336D"; return d })

            const makeAnnotations = d3.annotation()
                .type(d3.annotationLabel)
                .annotations(annotations)

            d3.select(".annotation-group")
                .call(makeAnnotations)
            d3.select("svg")
                .append("g")
                .attr("class", "annotation-group")
                .call(makeAnnotations)

            const u = svg.selectAll("rect").data(sortedData)

            u
                .join("rect")
                .transition()
                .duration(1000)
                .attr("x", x_scale(0))
                .attr("y", function (d) {
                    return y_scale(d.country);
                })
                .attr("width", function (d) {
                    return x_scale(d.score);
                })
                .attr("height", y_scale.bandwidth())
                .attr("fill", "#69b3a2");
        }

        const init = async () => {
            data15 = await d3.csv(
                "https://mengmutj.github.io/allyearscsv.csv",
                (d) => {
                    if (d.Year === "2015") {
                        return {
                            country: d.Country,
                            gdp: d.GDP_Capita,
                            lifeExpectancy: d.Life_Expectancy,
                            rank: d.Rank,
                            score: d.Score,
                            year: d.Year
                        };
                    }
                }
            );

            data16 = await d3.csv(
                "https://mengmutj.github.io/allyearscsv.csv",
                (d) => {
                    if (d.Year === "2016") {
                        return {
                            country: d.Country,
                            gdp: d.GDP_Capita,
                            lifeExpectancy: d.Life_Expectancy,
                            rank: d.Rank,
                            score: d.Score,
                            year: d.Year
                        };
                    }
                }
            );

            data17 = await d3.csv(
                "https://mengmutj.github.io/allyearscsv.csv",
                (d) => {
                    if (d.Year === "2017") {
                        return {
                            country: d.Country,
                            gdp: d.GDP_Capita,
                            lifeExpectancy: d.Life_Expectancy,
                            rank: d.Rank,
                            score: d.Score,
                            year: d.Year
                        };
                    }
                }
            );

            data18 = await d3.csv(
                "https://mengmutj.github.io/allyearscsv.csv",
                (d) => {
                    if (d.Year === "2018") {
                        return {
                            country: d.Country,
                            gdp: d.GDP_Capita,
                            lifeExpectancy: d.Life_Expectancy,
                            rank: d.Rank,
                            score: d.Score,
                            year: d.Year
                        };
                    }
                }
            );

            data19 = await d3.csv(
                "https://mengmutj.github.io/allyearscsv.csv",
                (d) => {
                    if (d.Year === "2019") {
                        return {
                            country: d.Country,
                            gdp: d.GDP_Capita,
                            lifeExpectancy: d.Life_Expectancy,
                            rank: d.Rank,
                            score: d.Score,
                            year: d.Year
                        };
                    }
                }
            );

            updateBar(data15)
        };
    </script>
</body>

</html>